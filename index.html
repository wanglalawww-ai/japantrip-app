<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººæ—…éŠè¨ˆç•« | Shared Travel Plan</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #F3F4F6; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        #map-container { z-index: 1; }
        .gps-pulse {
            width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%;
            background-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <div id="app" v-cloak class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100">

        <div v-if="!isFirebaseReady" class="absolute inset-0 z-[60] bg-white flex flex-col items-center justify-center">
            <i class="ph-duotone ph-spinner animate-spin text-4xl text-teal-600 mb-2"></i>
            <p class="text-slate-500 text-sm">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
        </div>

        <div v-if="syncStatus === 'saving'" class="absolute top-4 right-4 z-50 bg-teal-600 text-white text-[10px] px-2 py-1 rounded-full shadow opacity-80 flex items-center gap-1">
            <i class="ph-bold ph-arrows-clockwise animate-spin"></i> åŒæ­¥ä¸­...
        </div>

        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button @click="showTripMenu = true" class="text-teal-100 hover:text-white transition">
                        <i class="ph-bold ph-list text-2xl"></i>
                    </button>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                            {{ setup.destination || 'æ—…éŠè¨ˆç•«' }} <i class="ph-fill ph-airplane-tilt text-sm opacity-70"></i>
                        </h1>
                        <p class="text-xs text-teal-100 mt-0.5 font-light tracking-wider truncate">é›²ç«¯åŒæ­¥ç‰ˆ</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <button @click="viewMode = 'translate'" :class="viewMode === 'translate' ? 'bg-white text-teal-700 shadow-sm' : 'bg-teal-500/30 text-teal-200'" class="p-2.5 rounded-xl transition-all h-11 w-11 flex items-center justify-center border border-teal-500/30">
                        <i class="ph-bold ph-translate text-xl"></i>
                    </button>
                    <div class="flex bg-teal-800/50 p-1 rounded-lg">
                        <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-calendar-check text-lg"></i></button>
                        <button @click="viewMode = 'map'" :class="viewMode === 'map' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-map-trifold text-lg"></i></button>
                        <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-currency-dollar text-lg"></i></button>
                    </div>
                </div>
            </div>
            <div class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-xl cursor-pointer transition-all border-2" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-white shadow-lg scale-105' : 'bg-teal-500/50 text-teal-100 border-transparent hover:bg-teal-500'">
                    <span class="text-xs font-medium opacity-80">{{ day.shortDate }}</span>
                    <span class="text-lg font-bold">D{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-xl flex items-center justify-center border-2 border-teal-400 border-dashed text-teal-200 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24">
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start">
                        <div class="flex-1 relative pt-0.5">
                            <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <input v-model="currentDay.date" class="text-xl font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none" placeholder="Day 1">
                            <input v-model="currentDay.title" class="text-sm text-slate-500 bg-transparent border-b border-dashed border-slate-300 focus:border-teal-500 focus:outline-none w-full mt-1" placeholder="è¼¸å…¥ç•¶æ—¥ä¸»é¡Œ">
                        </div>
                    </div>

                    <div class="mb-6">
                         <div v-if="currentDay.flight" class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg p-4">
                            <button @click="currentDay.flight = null" class="absolute top-2 right-2 opacity-50 hover:opacity-100"><i class="ph-bold ph-x"></i></button>
                            <div class="flex justify-between items-center pt-2">
                                <div class="text-center w-1/3"><input v-model="currentDay.flight.startTime" type="time" class="bg-transparent text-2xl font-mono w-full text-center focus:outline-none"><div class="text-xs opacity-70">å‡ºç™¼</div></div>
                                <div class="text-center w-1/3"><i class="ph-fill ph-airplane rotate-90 text-2xl"></i></div>
                                <div class="text-center w-1/3"><input v-model="currentDay.flight.endTime" type="time" class="bg-transparent text-2xl font-mono w-full text-center focus:outline-none"><div class="text-xs opacity-70">æŠµé”</div></div>
                            </div>
                        </div>
                        <button v-else @click="currentDay.flight={startTime:'10:00', endTime:'14:00'}" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:text-teal-500 text-sm font-bold flex justify-center items-center gap-2"><i class="ph-bold ph-airplane-tilt"></i> æ–°å¢èˆªç­</button>
                    </div>

                    <div class="relative pl-4 border-l-2 border-teal-100 space-y-8">
                        <div v-for="(item, idx) in currentDay.items" :key="idx" class="relative group">
                            <div class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="item.type==='food'?'bg-orange-400':item.type==='shop'?'bg-pink-400':'bg-teal-500'"></div>
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                <div class="flex items-start gap-3">
                                    <div class="flex flex-col w-20 shrink-0 gap-2">
                                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-1 w-full h-16 flex flex-col items-center justify-center relative">
                                            <span class="text-xl font-bold font-mono">{{ item.time || '--:--' }}</span>
                                            <input v-model="item.time" type="time" class="absolute inset-0 opacity-0 cursor-pointer">
                                        </div>
                                        <select v-model="item.type" class="text-[10px] bg-white border border-slate-200 rounded p-1 w-full"><option value="spot">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shop">è³¼ç‰©</option><option value="transport">äº¤é€š</option></select>
                                    </div>
                                    <div class="flex-1 min-w-0 pt-1">
                                        <input v-model="item.activity" class="block w-full font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0" placeholder="è¡Œç¨‹åç¨±...">
                                        <div class="flex items-center gap-1 mt-1"><i class="ph-fill ph-map-pin text-teal-400 text-xs"></i><input v-model="item.location" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0" placeholder="åœ°é»"></div>
                                        <div class="flex items-center gap-1 mt-1"><i class="ph-bold ph-info text-orange-400 text-xs"></i><input v-model="item.note" class="flex-1 text-xs text-orange-600/90 bg-transparent border-none p-0 focus:ring-0" placeholder="å‚™è¨»"></div>
                                    </div>
                                    <button @click="removeItem(idx)" class="text-red-300 p-1"><i class="ph-bold ph-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <button @click="addItem" class="flex items-center gap-2 text-teal-400 hover:text-teal-600 text-sm font-medium px-2 py-1"><div class="w-2 h-2 bg-teal-300 rounded-full"></div><i class="ph-bold ph-plus"></i> æ–°å¢è¡Œç¨‹</button>
                    </div>
                </div>
            </transition>

            <div v-if="viewMode === 'map'" class="h-full relative">
                <div id="map" class="w-full h-full bg-slate-200"></div>
                <div class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg z-[400] flex justify-between items-center">
                    <div class="text-sm font-bold">ğŸ“ {{ currentDay.items.filter(i=>i.location).length }} å€‹åœ°é»</div>
                    <button @click="initMap" class="p-2 bg-teal-100 text-teal-600 rounded-lg"><i class="ph-bold ph-arrows-clockwise"></i></button>
                </div>
            </div>

            <div v-if="viewMode === 'money'" class="p-4 pb-24">
                <div class="bg-teal-600 text-white rounded-2xl p-6 shadow-lg mb-6 text-center relative">
                    <div class="absolute top-4 right-4 text-right"><div class="text-[10px] text-teal-200">åŒ¯ç‡</div><input v-model.number="setup.rate" type="number" step="0.001" class="w-16 text-right text-xs text-teal-900 rounded px-1"></div>
                    <div class="text-4xl font-bold font-mono">{{ setup.currency === 'JPY' ? 'Â¥' : '$' }} {{ totalExpense.toLocaleString() }}</div>
                    <div class="text-lg font-bold text-teal-200 mt-1">â‰ˆ NT$ {{ Math.round(totalExpense * (setup.rate||0.21)).toLocaleString() }}</div>
                </div>
                <div class="mb-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 mb-2">åˆ†å¸³æˆå“¡ (é€—è™Ÿåˆ†éš”)</div>
                    <input v-model="participantsStr" @change="updateParticipants" class="w-full text-sm bg-slate-50 rounded px-2 py-1 border border-slate-200" placeholder="æˆ‘, æœ‹å‹A">
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <div class="flex gap-2 mb-2">
                        <input v-model="newExpense.item" placeholder="é …ç›®" class="w-[65%] bg-slate-50 border-none rounded-lg text-sm px-3 py-2">
                        <select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-lg text-sm px-2 py-2"><option v-for="p in participants" :value="p">{{ p }}</option></select>
                    </div>
                    <div class="flex gap-2">
                        <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-full bg-slate-50 border-none rounded-lg text-sm px-3 py-2 font-mono">
                        <button @click="addExpense" class="bg-teal-600 text-white px-4 py-2 rounded-lg"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-teal-50 flex items-center justify-center text-teal-600 text-xs font-bold">{{ exp.payer.charAt(0) }}</div><div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div></div>
                        <div class="flex items-center gap-3"><span class="font-mono font-bold">{{ setup.currency === 'JPY' ? 'Â¥' : '$' }}{{ exp.amount }}</span><button @click="expenses.splice(idx, 1)" class="text-slate-300"><i class="ph-fill ph-x-circle"></i></button></div>
                    </div>
                </div>
            </div>

            <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col items-center">
                 <h2 class="text-2xl font-bold mb-8">Google ç¿»è­¯æ·å¾‘</h2>
                 <a href="https://translate.google.com/?op=images" target="_blank" class="w-full mb-4"><button class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg text-left"><div class="text-xs opacity-80 mb-1">ç›¸æ©Ÿ</div><div class="text-2xl font-bold">ç…§ç›¸ç¿»è­¯ <i class="ph-bold ph-camera"></i></div></button></a>
                 <a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode||'ja'}&op=translate`" target="_blank" class="w-full mb-4"><button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg text-left"><div class="text-xs opacity-80 mb-1">æˆ‘èªªä¸­æ–‡</div><div class="text-2xl font-bold">CH <i class="ph-bold ph-arrow-right"></i> {{ (setup.langCode||'ja').toUpperCase() }}</div></button></a>
            </div>
        </main>

        <transition name="fade">
            <div v-if="showTripMenu" class="fixed inset-0 z-50 flex">
                <div class="bg-white w-4/5 max-w-xs h-full shadow-2xl flex flex-col p-6 z-50">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">æˆ‘çš„æ—…ç¨‹</h2><button @click="showTripMenu=false"><i class="ph-bold ph-x text-xl"></i></button></div>
                    <button @click="createNewTrip" class="w-full py-3 mb-6 border-2 border-dashed border-teal-400 text-teal-600 rounded-xl font-bold">å»ºç«‹æ–°æ—…ç¨‹</button>
                    <div class="flex-1 overflow-y-auto space-y-3">
                        <div v-for="trip in tripList" :key="trip.id" @click="switchTrip(trip.id)" class="p-4 rounded-xl border cursor-pointer" :class="currentTripId===trip.id?'bg-teal-50 border-teal-500':'bg-slate-50 hover:bg-slate-100'">
                            <div class="font-bold">{{ trip.destination }}</div>
                            <div class="text-xs text-slate-400">{{ trip.startDate }}</div>
                            <button v-if="tripList.length>1" @click.stop="deleteTrip(trip.id)" class="text-red-300 text-xs mt-2 underline">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-black/50 backdrop-blur-sm" @click="showTripMenu=false"></div>
            </div>
        </transition>

        <div v-if="showSetupModal" class="absolute inset-0 bg-teal-800/90 backdrop-blur-sm z-50 flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-center mb-6">å»ºç«‹æ–°æ—…ç¨‹</h2>
                <div class="space-y-4">
                    <input v-model="setup.destination" placeholder="ç›®çš„åœ° (ä¾‹å¦‚: Tokyo)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold">
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model="setup.startDate" type="date" class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-3">
                        <input v-model.number="setup.days" type="number" min="1" placeholder="å¤©æ•¸" class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-3">
                    </div>
                    <button @click="initTrip" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl">é–‹å§‹è¦åŠƒ</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        // åŒ¯å…¥ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // å·²ç¶“å¹«æ‚¨å¡«å¥½æ‚¨çš„ Firebase è¨­å®šäº†ï¼
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBHvBa6P-kC6mZWuHZ--u_0W-X1kRB4Pgw",
            authDomain: "tokyotravelapp.firebaseapp.com",
            projectId: "tokyotravelapp",
            storageBucket: "tokyotravelapp.firebasestorage.app",
            messagingSenderId: "598769926426",
            appId: "1:598769926426:web:08f46bb4418d68e15b6ca3"
        };
        // ==========================================

        // åˆå§‹åŒ– Firebase
        const appInstance = initializeApp(firebaseConfig);
        const db = getFirestore(appInstance);

        createApp({
            setup() {
                // UI ç‹€æ…‹
                const viewMode = ref('plan');
                const showTripMenu = ref(false);
                const showSetupModal = ref(false);
                const isFirebaseReady = ref(false);
                const syncStatus = ref('idle'); // idle, saving
                const currentDayIdx = ref(0);
                
                // è³‡æ–™ç‹€æ…‹
                const tripList = ref([]);
                const currentTripId = ref(null);
                
                // ç•¶å‰è¡Œç¨‹çš„è©³ç´°è³‡æ–™
                const days = ref([]);
                const expenses = ref([]);
                const participantsStr = ref('æˆ‘, æ—…ä¼´A');
                const setup = ref({ destination: '', startDate: '', days: 5, rate: 0.21, currency: 'JPY', langCode: 'ja' });

                let unsubscribeTrip = null; // ç”¨ä¾†å–æ¶ˆç›£è½
                let unsubscribeList = null; // ç”¨ä¾†å–æ¶ˆåˆ—è¡¨ç›£è½
                let isRemoteUpdate = false; // é˜²æ­¢å¾ªç’°æ›´æ–°

                // --- Firebase æ ¸å¿ƒé‚è¼¯ ---

                // 1. è®€å–æ‰€æœ‰è¡Œç¨‹åˆ—è¡¨
                const loadTripList = () => {
                    const q = query(collection(db, "trips"), orderBy("createdAt", "desc"));
                    unsubscribeList = onSnapshot(q, (snapshot) => {
                        tripList.value = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        isFirebaseReady.value = true;
                        
                        // å¦‚æœæ²’æœ‰é¸æ“‡è¡Œç¨‹ï¼Œä¸”åˆ—è¡¨æœ‰è³‡æ–™ï¼Œé¸ç¬¬ä¸€å€‹
                        if (!currentTripId.value && tripList.value.length > 0) {
                            switchTrip(tripList.value[0].id);
                        } else if (tripList.value.length === 0) {
                            showSetupModal.value = true;
                        }
                    });
                };

                // 2. åˆ‡æ›/è®€å–ç‰¹å®šè¡Œç¨‹
                const switchTrip = (tripId) => {
                    if (unsubscribeTrip) unsubscribeTrip(); // å–æ¶ˆä¸Šä¸€å€‹ç›£è½
                    currentTripId.value = tripId;
                    showTripMenu.value = false;
                    isFirebaseReady.value = false;

                    // ç›£è½ç‰¹å®šæ–‡ä»¶çš„è®ŠåŒ–
                    unsubscribeTrip = onSnapshot(doc(db, "trips", tripId), (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            isRemoteUpdate = true; // æ¨™è¨˜é€™æ˜¯ä¾†è‡ªé›²ç«¯çš„æ›´æ–°
                            
                            // æ›´æ–°æœ¬åœ°è³‡æ–™
                            days.value = data.days || [];
                            expenses.value = data.expenses || [];
                            setup.value = data.setup || {};
                            participantsStr.value = data.participantsStr || '';
                            
                            isFirebaseReady.value = true;
                            // ç¨å¾®å»¶é²å¾Œè§£é™¤æ¨™è¨˜
                            nextTick(() => isRemoteUpdate = false);
                        }
                    });
                };

                // 3. å„²å­˜è³‡æ–™åˆ° Firebase (ä½¿ç”¨ Watch)
                // ç›£è½è³‡æ–™è®ŠåŒ–ï¼Œè‡ªå‹•ä¸Šå‚³
                watch([days, expenses, setup, participantsStr], async () => {
                    if (!currentTripId.value || isRemoteUpdate) return;
                    
                    syncStatus.value = 'saving';
                    try {
                        const tripRef = doc(db, "trips", currentTripId.value);
                        await setDoc(tripRef, {
                            days: JSON.parse(JSON.stringify(days.value)), // è½‰æˆç´”ç‰©ä»¶
                            expenses: JSON.parse(JSON.stringify(expenses.value)),
                            setup: JSON.parse(JSON.stringify(setup.value)),
                            participantsStr: participantsStr.value,
                            destination: setup.value.destination, // æ–¹ä¾¿åˆ—è¡¨é¡¯ç¤º
                            startDate: setup.value.startDate,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                    } catch (e) {
                        console.error("Sync error", e);
                    } finally {
                        setTimeout(() => syncStatus.value = 'idle', 500);
                    }
                }, { deep: true });


                // --- æ‡‰ç”¨ç¨‹å¼åŠŸèƒ½é‚è¼¯ ---

                const currentDay = computed(() => days.value[currentDayIdx.value] || { items:[], flight:null, date:'', title:'' });
                const participants = computed(() => participantsStr.value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });

                const createNewTrip = () => {
                    setup.value = { destination: '', startDate: new Date().toISOString().split('T')[0], days: 5, rate: 0.21, currency: 'JPY', langCode: 'ja' };
                    currentTripId.value = null;
                    showSetupModal.value = true;
                    showTripMenu.value = false;
                };

                const initTrip = async () => {
                    if (!setup.value.destination) return alert('è«‹è¼¸å…¥ç›®çš„åœ°');
                    
                    // ç”¢ç”Ÿé è¨­å¤©æ•¸çµæ§‹
                    const newDays = [];
                    const start = new Date(setup.value.startDate);
                    const dNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    for(let i=0; i<setup.value.days; i++) {
                        const curr = new Date(start); curr.setDate(start.getDate()+i);
                        const mm = curr.getMonth()+1; const dd = curr.getDate();
                        const fullDate = `${curr.getFullYear()}-${mm < 10 ? '0'+mm : mm}-${dd < 10 ? '0'+dd : dd}`;
                        newDays.push({
                            date: `${mm}/${dd} (${dNames[curr.getDay()]})`,
                            fullDate: fullDate,
                            shortDate: `${mm}/${dd}`,
                            title: i===0?'æŠµé”':`Day ${i+1}`,
                            items: [], flight: null
                        });
                    }

                    // å¯«å…¥ Firebase
                    try {
                        const docRef = await addDoc(collection(db, "trips"), {
                            setup: setup.value,
                            days: newDays,
                            expenses: [],
                            participantsStr: 'æˆ‘, æ—…ä¼´A',
                            createdAt: serverTimestamp(),
                            destination: setup.value.destination,
                            startDate: setup.value.startDate
                        });
                        switchTrip(docRef.id);
                        showSetupModal.value = false;
                    } catch (e) {
                        alert("å»ºç«‹å¤±æ•—ï¼š" + e.message);
                    }
                };

                const deleteTrip = async (id) => {
                    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿç„¡æ³•å¾©åŸã€‚')) return;
                    await deleteDoc(doc(db, "trips", id));
                    if(currentTripId.value === id) {
                        currentTripId.value = null;
                        days.value = [];
                    }
                };

                // --- Helper Functions ---
                const updateDate = (e, day) => {
                    const val = e.target.value; if(!val) return;
                    day.fullDate = val;
                    const d = new Date(val);
                    const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                    day.date = `${d.getMonth()+1}/${d.getDate()} (${w})`;
                    day.shortDate = `${d.getMonth()+1}/${d.getDate()}`;
                };
                const addItem = () => currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' });
                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => days.value.push({ date: `Day ${days.value.length+1}`, items: [] });
                const addExpense = () => { if(newExpense.value.item){ expenses.value.unshift({...newExpense.value}); newExpense.value.item=''; newExpense.value.amount=''; } };
                const updateParticipants = () => {}; // é€é watch è‡ªå‹•è™•ç†

                // Map
                let mapInstance = null;
                const initMap = async () => {
                    await nextTick();
                    if (!document.getElementById('map')) return;
                    if (mapInstance) { mapInstance.remove(); mapInstance = null; }
                    mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                    
                    const locs = currentDay.value.items.filter(i => i.location);
                    const bounds = L.latLngBounds();
                    for (const item of locs) {
                         try {
                             const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`);
                             const d = await res.json();
                             if (d && d.length > 0) {
                                 const lat = d[0].lat; const lon = d[0].lon;
                                 L.marker([lat, lon]).addTo(mapInstance).bindPopup(item.activity);
                                 bounds.extend([lat, lon]);
                             }
                         } catch(e){}
                    }
                    if(locs.length>0) mapInstance.fitBounds(bounds, {padding:[50,50]});
                };

                watch(viewMode, (v) => { if(v === 'map') initMap(); });

                onMounted(() => {
                    loadTripList();
                });

                return {
                    viewMode, showTripMenu, showSetupModal, isFirebaseReady, syncStatus,
                    tripList, currentTripId, switchTrip, createNewTrip, initTrip, deleteTrip,
                    days, currentDayIdx, currentDay, updateDate, addDay,
                    addItem, removeItem,
                    setup, expenses, newExpense, addExpense, totalExpense,
                    participants, participantsStr, updateParticipants,
                    initMap
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
